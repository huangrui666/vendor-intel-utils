From c2f59fd3fda047f6a9e94ca2e496432e59c706e6 Mon Sep 17 00:00:00 2001
From: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
Date: Thu, 29 Jul 2021 14:59:06 +0530
Subject: [PATCH] Add DRM_FORMAT_NV21 flex layout update in lockYCbCr

Some of the camera apps are requesting for NV21 streams.
As lockYCbCr fails with not supported, preview is not seen
with those apps.

Fix the issue by adding DRM_FORMAT_NV21 flex layoyt update
in

Note: Inorder to support apps requiring NV21 support, framework
and camera vHAL changes are required along with this change.

Change-Id: I625764149f1bd23298a9f4e58f756bd3a8adaa01
Signed-off-by: Jeevaka Prabu Badrappan <jeevaka.badrappan@intel.com>
---
 cros_gralloc/gralloc1/cros_gralloc1_module.cc | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/cros_gralloc/gralloc1/cros_gralloc1_module.cc b/cros_gralloc/gralloc1/cros_gralloc1_module.cc
index 9a837e2..24c6a61 100644
--- a/cros_gralloc/gralloc1/cros_gralloc1_module.cc
+++ b/cros_gralloc/gralloc1/cros_gralloc1_module.cc
@@ -607,6 +607,14 @@ int32_t CrosGralloc1::lockYCbCr(buffer_handle_t bufferHandle,
 		ycbcr->cstride = hnd->strides[1];
 		ycbcr->chroma_step = 4;
 		break;
+	case DRM_FORMAT_NV21:
+		ycbcr->y = addr[0];
+		ycbcr->cb = addr[1] + 1;
+		ycbcr->cr = addr[1];
+		ycbcr->ystride = hnd->strides[0];
+		ycbcr->cstride = hnd->strides[1];
+		ycbcr->chroma_step = 2;
+		break;
 	default:
 		return CROS_GRALLOC_ERROR_UNSUPPORTED;
 	}
-- 
2.25.1

